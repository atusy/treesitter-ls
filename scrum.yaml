# AI-Agentic Scrum Dashboard
# Single source of truth for all Scrum artifacts
# Git tracks when changes were made - no timestamps needed
# Order is priority - higher items have higher priority
# Historical details: git log -- scrum.yaml

---
# ==============================================================================
# RULES (Condensed)
# ==============================================================================

rules:
  core:
    - "Single Source of Truth: This dashboard is the only place for Scrum artifacts"
    - "Git as History: Do not add timestamps. Use git log for history"
    - "Order is Priority: Items higher in lists have higher priority"
    - "1 Sprint = 1 PBI: Each Sprint delivers exactly one PBI"

  definition_of_ready:
    summary: "Ready = AI can complete it without asking humans"
    flow: "draft -> refining -> ready"

  tdd_workflow:
    cycle: "pending -> red (commit) -> green (commit) -> refactoring (commit) -> completed"
    discipline: "ONE commit per TDD phase. Never mix behavioral and structural changes"

  agent_responsibilities:
    product_owner: "Product Backlog, Product Goal, Sprint acceptance"
    scrum_master: "Sprint config, Impediments, Retrospective, Metrics"
    developer: "Subtask status, Progress, Notes, Impediments"

---
# ==============================================================================
# QUICK STATUS
# ==============================================================================

quick_status:
  current_sprint: 33
  backlog: "3 PBIs (2 ready, 1 draft)"
  impediments: 0

---
# ==============================================================================
# PRODUCT GOAL
# ==============================================================================

product_goal:
  statement: "Enable zero-configuration usage of treesitter-ls: users can start the LSP server and get syntax highlighting for any supported language without manual setup."
  mvp_status: COMPLETE
  mvp_definition: |
    Minimum Viable Zero-Config Experience:
    1. User starts treesitter-ls with no initialization options
    2. User opens a .lua file (or any supported language)
    3. treesitter-ls automatically:
       a. Detects the language from file extension (via LSP languageId)
       b. Installs the parser and queries if missing (autoInstall: true by default)
       c. Uses default searchPaths (~/.local/share/treesitter-ls)
       d. Provides semantic highlighting
    4. Power users can still override with explicit configuration
  owner: "@scrum-team-product-owner"

---
# ==============================================================================
# PRODUCT BACKLOG (Active Items Only)
# ==============================================================================
# Completed PBIs: PBI-001 through PBI-039
# For details: git log -- scrum.yaml

product_backlog:
  - id: PBI-040
    title: "Remove test-only calculate_effective_range function"
    status: in_progress
    user_story: |
      As a maintainer,
      I want to remove the redundant calculate_effective_range function,
      so that the codebase has a single clear API for effective range calculation.
    acceptance_criteria:
      - criterion: "AC1: calculate_effective_range function removed"
        verification: "grep -c 'pub fn calculate_effective_range\\b' src/analysis/offset_calculator.rs returns 0"
      - criterion: "AC2: calculate_effective_range_with_text renamed to calculate_effective_range"
        verification: "grep -c 'pub fn calculate_effective_range' src/analysis/offset_calculator.rs returns 1"
      - criterion: "AC3: All callers updated"
        verification: "grep -r 'calculate_effective_range_with_text' src/ returns 0"
      - criterion: "AC4: All tests pass"
        verification: "cargo test --lib -- offset_calculator"
      - criterion: "AC5: No REVIEW comments remain in file"
        verification: "grep -c '// REVIEW:' src/analysis/offset_calculator.rs returns 0"
    notes: |
      Review finding: calculate_effective_range is only used in tests.

      Current state:
      - calculate_effective_range (line 33) - only applies column offsets, only used in tests
      - calculate_effective_range_with_text (line 46) - full implementation with row+column offsets

      Action:
      1. Remove calculate_effective_range
      2. Rename calculate_effective_range_with_text to calculate_effective_range
      3. Update all callers (grep shows only refactor.rs uses it)

  - id: PBI-041
    title: "Consolidate query resolution API in QueryLoader"
    status: draft
    user_story: |
      As a maintainer,
      I want to simplify the QueryLoader API,
      so that there is a single clear entry point for query resolution.
    acceptance_criteria:
      - criterion: "AC1: Single resolve_query method exists"
        verification: "grep -c 'pub fn resolve_query\\b' src/language/query_loader.rs returns 1"
      - criterion: "AC2: resolve_query_with_inheritance removed or made private"
        verification: "grep -c 'pub fn resolve_query_with_inheritance' src/language/query_loader.rs returns 0"
      - criterion: "AC3: All tests pass"
        verification: "cargo test --lib -- query_loader"
      - criterion: "AC4: No REVIEW comments remain in file"
        verification: "grep -c '// REVIEW:' src/language/query_loader.rs returns 0"
    notes: |
      Review finding: Consider making visited parameter optional in resolve_query_recursive
      to unify resolve_query_with_inheritance and resolve_query_recursive.

      Current state (line 12):
      - resolve_query_with_inheritance - public entry point that creates HashSet
      - resolve_query_recursive - private helper with visited parameter

      Potential approach: Make visited parameter optional (Option<&mut HashSet>),
      allowing a single public method named simply "resolve_query".

      Status: draft - needs investigation to confirm approach is sound

  - id: PBI-042
    title: "Simplify CONFIG_TEMPLATE to minimal active TOML"
    status: ready
    story_points: 1
    user_story: |
      As a user,
      I want the generated config to contain only a doc link and active settings,
      So that I can use it immediately without uncommenting or editing.
    acceptance_criteria:
      - criterion: "AC1: Only doc link comment at top"
        verification: "grep -c '^#' on CONFIG_TEMPLATE returns 1 (only doc link)"
      - criterion: "AC2: Settings are active (not commented)"
        verification: "CONFIG_TEMPLATE contains 'autoInstall = true' (not '# autoInstall')"
      - criterion: "AC3: Valid TOML"
        verification: "toml parse succeeds on CONFIG_TEMPLATE"
    notes: |
      Simplify CONFIG_TEMPLATE in src/bin/main.rs:
      Current:
        # treesitter-ls configuration
        # Documentation: ...
        # Auto-install missing parsers... (explanation)
        # autoInstall = true              (commented out)
      New:
        # Documentation: ...
        autoInstall = true

  - id: PBI-043
    title: "config init outputs to stdout by default"
    status: ready
    story_points: 3
    depends_on: [PBI-042]
    user_story: |
      As a user scripting with treesitter-ls CLI,
      I want `treesitter-ls config init` to emit to stdout when no output file is specified,
      So that I can pipe to other tools, preview before saving, or redirect to custom location.
    acceptance_criteria:
      - criterion: "AC1: Default outputs to stdout"
        verification: "treesitter-ls config init outputs to stdout; no file created"
      - criterion: "AC2: --output flag writes to file"
        verification: "treesitter-ls config init --output custom.toml creates custom.toml"
      - criterion: "AC3: --output with --force overwrites"
        verification: "treesitter-ls config init --output existing.toml --force overwrites"
      - criterion: "AC4: --output refuses overwrite without --force"
        verification: "treesitter-ls config init --output existing.toml fails with error"
      - criterion: "AC5: --force without --output warns"
        verification: "treesitter-ls config init --force warns to stderr, outputs to stdout"
      - criterion: "AC6: --output - means stdout"
        verification: "treesitter-ls config init --output - outputs to stdout"
    notes: |
      PO Decisions:
      - Breaking change acceptable (unreleased)
      - NO short flag (-o) - use --output only
      - Support --output - for explicit stdout
      - Warn when --force used without --output

      Technical changes in src/bin/main.rs:
      - ConfigAction::Init: add `output: Option<PathBuf>` (long flag only)
      - run_config_init(output: Option<PathBuf>, force: bool)
      - stdout when output is None or "-"
      - Warn to stderr if --force without --output
      - Update existing tests to use --output flag

---
# ==============================================================================
# DEFINITION OF READY
# ==============================================================================

definition_of_ready:
  criteria:
    - "AI can complete this story without human input"
    - "User story has role, capability, and benefit"
    - "At least 3 acceptance criteria with verification commands"
    - "Dependencies are resolved or not blocking"

---
# ==============================================================================
# DEFINITION OF DONE
# ==============================================================================

definition_of_done:
  checks:
    - name: "All unit tests pass"
      run: "make test"
    - name: "Code quality checks pass"
      run: "make check"
    - name: "E2E tests pass"
      run: "make test_nvim"

---
# ==============================================================================
# CURRENT SPRINT
# ==============================================================================

current_sprint:
  number: 33
  pbi: PBI-040
  goal: "Simplify the offset calculation API by consolidating to a single calculate_effective_range function"
  subtasks:
    - id: "33.1"
      title: "Migrate tests to use calculate_effective_range_with_text"
      status: pending
      notes: |
        Update 2 tests in offset_calculator.rs:
        - test_calculate_effective_range_with_positive_offset
        - test_calculate_effective_range_with_default_offset
        These tests use the simple calculate_effective_range function.
        Migrate them to use calculate_effective_range_with_text with text parameter.
    - id: "33.2"
      title: "Remove calculate_effective_range function"
      status: pending
      notes: |
        Remove the now-unused calculate_effective_range function (lines 29-38).
        This includes the docstring and the function body.
    - id: "33.3"
      title: "Rename calculate_effective_range_with_text to calculate_effective_range"
      status: pending
      notes: |
        Rename the function and update all callers:
        - src/analysis/offset_calculator.rs (definition + tests)
        - src/analysis/refactor.rs (import + 2 call sites)
        - src/analysis/selection/range_builder.rs (import + 3 call sites)
        - src/analysis/selection/injection_aware.rs (import + 2 call sites)
        - src/analysis/semantic.rs (import + 1 call site)

---
# ==============================================================================
# COMPLETED SPRINTS (Summary Only)
# ==============================================================================
# For detailed subtasks and commits: git log -- scrum.yaml

completed_sprints:
  - sprint: 32
    pbi: PBI-039
    outcome: "Removed test-only wrapper functions, migrated 18 test call sites to CodeActionOptions builder"
  - sprint: 31
    pbi: PBI-033
    outcome: "Consolidated code action functions to single entry point with CodeActionOptions builder pattern"
  - sprint: 30
    pbi: PBI-032
    outcome: "Split lsp_impl.rs from 2327 to 1299 lines by extracting auto_install module"
  - sprint: 29
    pbi: PBI-038
    outcome: "Documented logging targets (lock_recovery, crash_recovery, query) in README"
  - sprint: 28
    pbi: PBI-036
    outcome: "Consolidated recover_poison() with context parameter, removed context-less variant"
  - sprint: 27
    pbi: PBI-037
    outcome: "Changed crash detection logging from warn to error level"
  - sprint: 26
    pbi: PBI-035
    outcome: "Standardized log targets across all log::warn! calls"
  - sprint: 25
    pbi: PBI-034
    outcome: "Initialized logging backend with env_logger, enabling RUST_LOG configuration"
  - sprint: 24
    pbi: PBI-031
    outcome: "Added phase markers in handle_semantic_tokens_full for better readability"
  - sprint: 23
    pbi: PBI-030
    outcome: "Standardized lock handling with LockResultExt trait, reduced duplication"
  - sprint: 22
    pbi: PBI-029
    outcome: "Removed dead code: deprecated functions, placeholder tests, stale annotations"
  - sprint: 21
    pbi: PBI-028
    outcome: "Fixed default_search_paths() to return base directory, enabling zero-config mode"
  - sprint: 20
    pbi: PBI-027
    outcome: "Fixed markdown selection range test expectation to match AST structure"
  - sprint: 19
    pbi: PBI-024
    outcome: "Added language uninstall command with confirmation prompt and --all flag"
  - sprint: 18
    pbi: PBI-023
    outcome: "Added language status command to show installed languages and missing components"
  - sprint: 17
    pbi: PBI-022
    outcome: "Added config init command to generate treesitter-ls.toml template"
  - sprint: 16
    pbi: PBI-021
    outcome: "Added Prerequisites section to docs/README.md with dependency requirements"
  - sprint: 15
    pbi: PBI-026
    outcome: "CLI migrated to hierarchical structure: treesitter-ls language {install,list}"
  - sprint: 14
    pbi: PBI-025
    outcome: "ADR documentation with template and ADR-0001 (hierarchical CLI subcommands)"
  - sprint: 13
    pbi: PBI-020
    outcome: "Query inheritance support via parse_inherits_directive() and resolve_query_with_inheritance()"
  - sprint: 12
    pbi: PBI-016
    outcome: "Parser crash resilience via state file detection and CLI recovery"
  - sprint: 11
    pbi: PBI-010
    outcome: "Cache parsers.lua locally with 1-hour TTL and --no-cache flag"
  - sprint: 10
    pbi: PBI-015
    outcome: "Fixed git checkout for tag revisions using FETCH_HEAD"
  - sprint: 9
    pbi: [PBI-017, PBI-018, PBI-019]
    outcome: "Zero-Config MVP complete - default searchPaths, autoInstall=true by default"
  - sprint: 8
    pbi: PBI-013
    outcome: "Auto-install for injected languages on file open"
  - sprint: 7
    pbi: PBI-008
    outcome: "Auto-install infrastructure (silent background install)"
  - sprint: 6
    pbi: PBI-009
    outcome: "Combined install command (parser + queries)"
  - sprint: 5
    pbi: PBI-006
    outcome: "Parser compilation via tree-sitter CLI"
  - sprint: 4
    pbi: PBI-005
    outcome: "Query downloading from nvim-treesitter"
  - sprint: 3
    pbi: PBI-004
    outcome: "CLI infrastructure with clap"
  - sprint: 2
    pbi: PBI-002
    outcome: "Unified semantic token handlers; fixed PBI-003"
  - sprint: 1
    pbi: PBI-001
    outcome: "Semantic tokens for injected languages"

---
# ==============================================================================
# IMPEDIMENTS
# ==============================================================================

impediments:
  active: []
  # Format: {id, description, impact, severity, status}

---
# ==============================================================================
# AGENTS
# ==============================================================================

agents:
  roles:
    product_owner: "@scrum-team-product-owner"
    scrum_master: "@scrum-team-scrum-master"
    developer: "@scrum-team-developer"
  events:
    planning: "@scrum-event-sprint-planning"
    review: "@scrum-event-sprint-review"
    retrospective: "@scrum-event-sprint-retrospective"
    refinement: "@scrum-event-backlog-refinement"
