# Review

## Findings

1. **Critical – hover requests now race each other and can receive results for the wrong document** (`src/lsp/bridge/tokio_async_pool.rs:429-495`, `src/lsp/lsp_impl/text_document/hover.rs:122-139`). The new async pool hands out an `Arc<TokioAsyncBridgeConnection>` and every hover call edits the single virtual file (didOpen/didChange) and fires a `textDocument/hover` without exclusive access to the connection. If two hover requests arrive close together (very common when a client triggers hover while the user is still moving the cursor), their `didChange` and hover RPCs interleave, so rust-analyzer answers request A with the content that request B just wrote. The old `LanguageServerPool::take_connection` removed the connection from the pool until the request finished, which prevented this. We need to restore per-connection serialization (e.g., wrap the connection in a `tokio::Mutex`/semaphore or reintroduce take/return semantics) before we can trust the async path.

2. **Major – document versions can go backwards, violating the LSP contract** (`src/lsp/bridge/tokio_async_pool.rs:505-540`). `sync_document` reads the current version from `DashMap`, increments it, and writes the update without any synchronization. When two requests run concurrently they can both read the same `current_version` and each send `version + 1`, so the server sees duplicate or decreasing version numbers and may drop edits. Please guard version updates with a per-URI lock or use an atomic `fetch_add` to ensure versions stay monotonically increasing even when multiple async tasks call `sync_document`.

3. **Major – $/progress notifications no longer reach the LSP client after the initial indexing wait** (`src/lsp/lsp_impl/text_document/hover.rs:122-139`, `src/lsp/lsp_impl.rs:507-545`, `src/lsp/bridge/tokio_async_pool.rs:252-258,393-395`). The handler used to forward the notifications captured during each `hover_with_notifications` call; that block has been removed. The replacement forwarder task expects the pool to feed a channel, but the pool only calls `notification_sender.try_send` while draining spawn-time notifications and during the first `wait_for_indexing`. After that, nothing ever drains `notification_receivers`, so `$ /progress` messages emitted during real requests are dropped and the new forwarder never forwards anything. Clients therefore lose incremental progress feedback. We either need a background task that continuously drains every connection’s notification receiver and forwards to `tokio_notification_tx`, or we need to reintroduce per-request forwarding.

4. **Major – first hover can stall for 60s for servers that emit ≤1 indexing notification** (`src/lsp/bridge/tokio_async_pool.rs:334-410`). `wait_for_indexing` hardcodes `min_diagnostics = 2`, yet `is_indexing_complete` returns true not only for diagnostics but also for `$ /progress` “end” messages. Servers such as lua-language-server or rust-analyzer on trivial files often emit only a single event (or none) before being ready, so `diagnostics_count` never reaches 2 and we sit in the loop until the 60 s timeout. That regresses AC4 (“hover requests return valid responses through async path”). Please treat a single completion signal as sufficient (or make the requirement configurable per server) so that we don’t block the first hover on an arbitrary 60 s delay.

